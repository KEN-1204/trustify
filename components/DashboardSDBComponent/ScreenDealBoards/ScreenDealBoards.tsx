import {
  Dispatch,
  DragEvent,
  FormEvent,
  Fragment,
  MouseEvent,
  SetStateAction,
  Suspense,
  memo,
  useEffect,
  useMemo,
  useState,
} from "react";
import styles from "./ScreenDealBoards.module.css";
import { DealBoard } from "./DealBoard/DealBoard";
import { AvatarIcon } from "@/components/Parts/AvatarIcon/AvatarIcon";
import { EntityGroupByParent, FiscalYears, MemberAccounts } from "@/types";
import useDashboardStore from "@/store/useDashboardStore";
import { SpinnerBrand } from "@/components/Parts/SpinnerBrand/SpinnerBrand";
import { ErrorBoundary } from "react-error-boundary";
import { ErrorFallback } from "@/components/ErrorFallback/ErrorFallback";
import { ProgressCircle } from "@/components/Parts/Charts/ProgressCircle/ProgressCircle";
import { ProgressNumber } from "@/components/Parts/Charts/ProgressNumber/ProgressNumber";
import { GradientModal } from "@/components/Parts/GradientModal/GradientModal";
import { EditModalDealCard } from "./EditModalDealCard/EditModalDealCard";
import { formatDisplayPrice } from "@/utils/Helpers/formatDisplayPrice";
import { SpinnerX } from "@/components/Parts/SpinnerX/SpinnerX";
import { TbSnowflake, TbSnowflakeOff } from "react-icons/tb";
import useStore from "@/store";
import { useQueryMemberListByParentEntity } from "@/hooks/useQueryMemberListByParentEntity";
import { useQueryClient } from "@tanstack/react-query";

type Props = {
  // memberList: Entity[];
  displayEntityGroup: (EntityGroupByParent & { parent_entity_level: string; parent_entity_level_id: string }) | null;
  // periodType: string;
  // period: number;
};

// üå†ÂêÑ„É°„É≥„Éê„Éº„ÅÆ„Éç„ÇøË°®„Çí‰∏ÄË¶ß„ÅßË°®Á§∫„Åô„Çã„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà
const ScreenDealBoardsMemo = ({ displayEntityGroup }: Props) => {
  const userProfileState = useDashboardStore((state) => state.userProfileState);
  const isOpenCongratulationsModal = useDashboardStore((state) => state.isOpenCongratulationsModal);
  const setIsOpenCongratulationsModal = useDashboardStore((state) => state.setIsOpenCongratulationsModal);
  const setIsRequiredInputSoldProduct = useDashboardStore((state) => state.setIsRequiredInputSoldProduct);
  const setSelectedRowDataProperty = useDashboardStore((state) => state.setSelectedRowDataProperty);
  const setIsOpenUpdatePropertyModal = useDashboardStore((state) => state.setIsOpenUpdatePropertyModal);
  // ÊúüÈñì
  const activePeriodSDB = useDashboardStore((state) => state.activePeriodSDB);
  // ÈÅ∏Êäû‰∏≠„ÅÆ„Éç„Çø„Ç´„Éº„Éâ
  const selectedDealCard = useDashboardStore((state) => state.selectedDealCard);
  // „Éç„Çø„Ç´„Éº„Éâ„ÇØ„É™„ÉÉ„ÇØÊôÇ„Å´Ë°®Á§∫„Åô„ÇãÊ¶ÇË¶Å„É¢„Éº„ÉÄ„É´
  const isOpenDealCardModal = useDashboardStore((state) => state.isOpenDealCardModal);
  // ÈÅ∏Êäû„Åï„Çå„Åü„É°„É≥„Éê„Éº„ÅÆid„ÇíDealBoard„Å´props„ÅßÊ∏°„Åô
  const activeThemeColor = useDashboardStore((state) => state.activeThemeColor);

  // sticky„Çí‰ªò‰∏é„Åô„Çãrow
  const [stickyRow, setStickyRow] = useState<string | null>(null);

  if (!userProfileState || !userProfileState?.company_id) return null;

  // if (!periodType || !period) {
  if (!activePeriodSDB) {
    return (
      <div className="flex-center h-[80dvh] w-[100vw]">
        {/* <SpinnerBrand bgColor="var(--color-sdb-bg)" /> */}
        <span></span>
      </div>
    );
  }

  const queryClient = useQueryClient();
  // üîπË°®Á§∫‰∏≠„ÅÆ‰ºöË®àÂπ¥Â∫¶(„Ç∞„É≠„Éº„Éê„É´)
  const selectedFiscalYearTarget = useDashboardStore((state) => state.selectedFiscalYearTarget);

  if (selectedFiscalYearTarget === null) return null;

  const fiscalYearQueryData: FiscalYears | undefined = queryClient.getQueryData([
    "fiscal_year",
    "sales_target",
    selectedFiscalYearTarget,
  ]);

  const entityIds = useMemo(() => {
    if (!displayEntityGroup) return null;
    return displayEntityGroup.entities.map((entity) => entity.entity_id);
  }, []);

  // üîπÂ£≤‰∏äÁõÆÊ®ô„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„ÇãÂ†¥Âêà„Å´„ÅØ„Ç®„É≥„ÉÜ„Ç£„ÉÜ„Ç£„Ç∞„É´„Éº„ÉóÂÜÖ„ÅÆÂêÑ„Ç®„É≥„ÉÜ„Ç£„ÉÜ„Ç£„ÅÆ„É°„É≥„Éê„Éº„Ç¢„Ç´„Ç¶„É≥„Éà„Éá„Éº„Çø„ÇíÂèñÂæó
  const {
    data: queryDataMemberGroupByParentEntity,
    error: isErrorQueryMemberList,
    isLoading: IsLoadingQueryMemberList,
  } = useQueryMemberListByParentEntity({
    entityIds: entityIds,
    parentEntityLevel: displayEntityGroup?.parent_entity_level ?? null,
    parentEntityId: displayEntityGroup?.parent_entity_id ?? null,
    isReady: !!entityIds?.length,
  });

  // // „É°„É≥„Éê„Éº„Ç®„É≥„ÉÜ„Ç£„ÉÜ„Ç£
  // const selectedObjSectionSDBMember = useDashboardStore((state) => state.selectedObjSectionSDBMember);
  // const setSelectedObjSectionSDBMember = useDashboardStore((state) => state.setSelectedObjSectionSDBMember);

  const [memberList, setMemberList] = useState<
    | (MemberAccounts & {
        company_id: string;
        company_name: string;
      })[]
    | null
  >(null);

  const displayMemberList = useMemo(() => {
    return queryDataMemberGroupByParentEntity ? queryDataMemberGroupByParentEntity : memberList ?? null;
  }, [queryDataMemberGroupByParentEntity, memberList]);

  // „Éç„ÇøË°®„Éú„Éº„Éâ„Å´Ê∏°„ÅôidÈÖçÂàó„Å´Â§âÊèõ
  // const memberListSectionMember: MemberAccounts[] = useMemo(() => {
  //   if (!selectedObjSectionSDBMember) return [];
  //   const newIdList = [selectedObjSectionSDBMember];
  //   return newIdList;
  // }, [selectedObjSectionSDBMember]);

  // ------------------------- ‚úÖÂàùÂõû„Éû„Ç¶„É≥„ÉàÊôÇ‚úÖ -------------------------
  // Â£≤‰∏äÁõÆÊ®ô„Å®ÁµÑÁπîÊßãÊàê„ÅåÊú™Ë®≠ÂÆö„ÅÆÂ†¥Âêà„Å´„ÅØ„ÄÅËá™Ë∫´„ÅÆ„Éá„Éº„Çø„ÅÆ„ÅøË°®Á§∫„Åô„Çã
  useEffect(() => {
    if (!userProfileState) return;
    // „É°„É≥„Éê„Éº„Éá„Éº„Çø„ÇíÂèñÂæó„Åß„Åç„Å¶„ÅÑ„ÇãÂ†¥Âêà„ÅØmemberList„Å´„Çª„ÉÉ„Éà
    if (queryDataMemberGroupByParentEntity) return;

    if (displayEntityGroup === null) {
      // Â£≤‰∏äÁõÆÊ®ô„Å®ÁµÑÁπîÊßãÊàê„ÅåÊú™Ë®≠ÂÆö„ÅÆÂ†¥Âêà„Å´„ÅØ„ÄÅËá™Ë∫´„ÅÆ„Éá„Éº„Çø„ÅÆ„ÅøË°®Á§∫„Åô„Çã
      // „É¶„Éº„Ç∂„ÉºËá™Ë∫´„ÇíÂàùÊúüÂÄ§„Å´„Çª„ÉÉ„Éà
      const u = userProfileState;
      const initialMemberObj = {
        id: u.id,
        created_at: u.created_at,
        updated_at: u.updated_at,
        avatar_url: u.avatar_url,
        is_subscriber: u.is_subscriber,
        company_role: u.company_role,
        role: u.role,
        stripe_customer_id: u.stripe_customer_id,
        last_name: u.last_name,
        first_name: u.first_name,
        email: u.email,
        department: u.department,
        position_name: u.position_name,
        position_class: u.position_class,
        direct_line: u.direct_line,
        company_cell_phone: u.company_cell_phone,
        personal_cell_phone: u.personal_cell_phone,
        occupation: u.occupation,
        direct_fax: u.direct_fax,
        signature_stamp_id: u.signature_stamp_id,
        employee_id: u.employee_id,
        is_active: u.is_active,
        profile_name: u.profile_name,
        accept_notification: u.accept_notification,
        first_time_login: u.first_time_login,
        office: u.office,
        section: u.section,
        unit: u.unit,
        usage: u.usage,
        purpose_of_use: u.purpose_of_use,
        subscribed_account_id: u.subscribed_account_id,
        account_created_at: u.account_created_at,
        account_company_role: u.account_company_role,
        account_state: u.account_state,
        account_invited_email: null,
        assigned_department_id: u.assigned_department_id,
        assigned_department_name: u.assigned_department_name,
        assigned_section_id: u.assigned_section_id,
        assigned_section_name: u.assigned_section_name,
        assigned_unit_id: u.assigned_unit_id,
        assigned_unit_name: u.assigned_unit_name,
        assigned_office_id: u.assigned_office_id,
        assigned_office_name: u.assigned_office_name,
        assigned_employee_id: u.assigned_employee_id,
        assigned_employee_id_name: u.assigned_employee_id_name,
        assigned_signature_stamp_id: u.assigned_signature_stamp_id,
        assigned_signature_stamp_url: u.assigned_signature_stamp_url,
        company_id: u.company_id,
        company_name: u.customer_name,
      } as MemberAccounts & {
        company_id: string;
        company_name: string;
      };
      setMemberList([initialMemberObj]);
    }
  }, [displayEntityGroup]);
  // ------------------------- ‚úÖÂàùÂõû„Éû„Ç¶„É≥„ÉàÊôÇ‚úÖ -------------------------

  // useEffect„Åß„É°„É≥„Éê„Éº„É™„Çπ„Éà„ÅåÂèñÂæó„Åß„Åç„ÅüÁä∂ÊÖã„ÅßJSX„Çí„É¨„É≥„ÉÄ„É™„É≥„Ç∞„Åô„Çã
  const [isMounted, setIsMounted] = useState(false);

  useEffect(() => {
    if (isMounted) return;

    setIsMounted(true);
  }, []);

  // ÂÖ®„Å¶„ÅÆ„Éú„Éº„Éâ„Åå„Éû„Ç¶„É≥„Éà„Åó„ÅüÂæå„Å´ProgressCircle„Çí„Éû„Ç¶„É≥„Éà„Åï„Åõ„Çã
  const [isRenderProgress, setIsRenderProgress] = useState(false);

  useEffect(() => {
    if (activePeriodSDB.periodType && activePeriodSDB.period) {
      setTimeout(() => {
        setIsRenderProgress(true);
        console.log("ProgressCircle„É¨„É≥„ÉÄ„É™„É≥„Ç∞");
      }, 1500);
    }
  }, []);

  const FallbackDealBoard = () => {
    return (
      <div className={`flex-center h-[288px] w-[100vw] px-[24px] py-[12px]`}>
        {/* <SpinnerBrand
          // bgColor="var(--color-sdb-bg)"
          bgColor="#121212"
          withBorder
          withShadow
          bgTransition={`${activeThemeColor !== "theme-black-gradient" ? `transition-bg05` : ``}`}
        /> */}
        <SpinnerX />
      </div>
    );
  };

  // ÂèóÊ≥®Ê∏à„Åø„Å´Â§âÊõ¥Âæå„Å´Ë°®Á§∫„Åô„Çã„É¢„Éº„ÉÄ„É´„ÅÆ„ÄåÂèçÊò†„Åô„Çã„Äç„Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØÊôÇ„Å´ÂÆüË°å„Åï„Çå„ÇãÈñ¢Êï∞
  const handleClickActiveSoldModal = () => {
    setIsOpenUpdatePropertyModal(true); // Ê°à‰ª∂Á∑®ÈõÜ„É¢„Éº„ÉÄ„É´„ÇíÈñã„Åè
    setIsRequiredInputSoldProduct(true); // Ê°à‰ª∂Á∑®ÈõÜ„É¢„Éº„ÉÄ„É´„Å´ÂèóÊ≥®ÂæåÂ£≤‰∏äÂÖ•Âäõ„Çπ„ÉÜ„Éº„Çø„Çπ„ÇíÊ∏°„Åô
    setIsOpenCongratulationsModal(false); // „ÅäÁ•ù„ÅÑ„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
  };
  // ÂèóÊ≥®Ê∏à„Åø„Å´Â§âÊõ¥Âæå„Å´Ë°®Á§∫„Åô„Çã„É¢„Éº„ÉÄ„É´„ÅÆ„ÄåÂèçÊò†„Åô„Çã„Äç„Éú„Çø„É≥„ÇØ„É™„ÉÉ„ÇØÊôÇ„Å´ÂÆüË°å„Åï„Çå„ÇãÈñ¢Êï∞
  const handleClickCancelSoldModal = () => {
    setSelectedRowDataProperty(null); // ÈÅ∏Êäû‰∏≠„ÅÆRowData„Çí„É™„Çª„ÉÉ„Éà
    setIsOpenCongratulationsModal(false); // „ÅäÁ•ù„ÅÑ„É¢„Éº„ÉÄ„É´„ÇíÈñâ„Åò„Çã
  };

  // ===================== üåü„ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó 3ÁÇπ„É™„Éº„ÉÄ„Éº„ÅÆÊôÇ„Å´„ÉÑ„Éº„É´„ÉÅ„ÉÉ„ÉóË°®Á§∫üåü =====================
  const hoveredItemPos = useStore((state) => state.hoveredItemPos);
  const setHoveredItemPos = useStore((state) => state.setHoveredItemPos);
  type TooltipParams = {
    // e: MouseEvent<HTMLDivElement, MouseEvent>;
    e: MouseEvent<HTMLDivElement | HTMLSpanElement, globalThis.MouseEvent>;
    // e: MouseEvent<HTMLElement, MouseEvent<Element, globalThis.MouseEvent>> | MouseEvent<HTMLDivElement, MouseEvent>;
    display: string;
    content: string;
    content2?: string | undefined | null;
    marginTop?: number;
    itemsPosition?: string;
  };
  const handleOpenTooltip = ({
    e,
    display,
    content,
    content2,
    marginTop = 0,
    itemsPosition = "center",
  }: TooltipParams) => {
    // „Éõ„Éê„Éº„Åó„Åü„Ç¢„Ç§„ÉÜ„É†„Å´„ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó„ÇíË°®Á§∫
    const { x, y, width, height } = e.currentTarget.getBoundingClientRect();
    // console.log("„ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éóx, y width , height", x, y, width, height);

    setHoveredItemPos({
      x: x,
      y: y,
      itemWidth: width,
      itemHeight: height,
      content: content,
      content2: content2,
      display: display,
      marginTop: marginTop,
      itemsPosition: itemsPosition,
    });
  };
  // „ÉÑ„Éº„É´„ÉÅ„ÉÉ„Éó„ÇíÈùûË°®Á§∫
  const handleCloseTooltip = () => {
    if (hoveredItemPos) setHoveredItemPos(null);
  };
  // ==================================================================================

  // --------------------------- üå†Â≠ê„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà„ÇíÈ†ÜÁï™„Å´„Éï„Çß„ÉÉ„ÉÅ„Åï„Åõ„Çãüå† ---------------------------
  const [currentActiveIndex, setCurrentActiveIndex] = useState(0); // È†ÜÁï™„Å´„Éï„Çß„ÉÉ„ÉÅ„ÇíË®±ÂèØ
  const [allFetched, setAllFetched] = useState(false); // „Çµ„ÉñÁõÆÊ®ô„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà„ÅÆ„Éï„Çß„ÉÉ„ÉÅ„ÅåÂÖ®„Å¶ÂÆå‰∫Ü„Åó„Åü„Çâtrue„Å´Â§âÊõ¥

  // ÂÖ®Â≠ê„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà„Åå„Éï„Çß„ÉÉ„ÉÅÂÆå‰∫Ü„Åó„Åü„Åã„ÇíÁõ£Ë¶ñ
  useEffect(() => {
    if (!displayMemberList) return;
    // „É°„É≥„Éê„Éº„É™„Çπ„Éà„Çà„ÇäactiveIndex„ÅåÂ§ß„Åç„Åè„Å™„Å£„ÅüÂ†¥Âêà„ÄÅÂÖ®„Å¶„Éï„Çß„ÉÉ„ÉÅ„ÅåÂÆå‰∫Ü
    if (currentActiveIndex >= displayMemberList.length) {
      setAllFetched(true);
    }
  }, [currentActiveIndex]);

  // „Éç„ÇøË°®„ÇíÈ†ÜÁï™„Å´„Éï„Çß„ÉÉ„ÉÅË®±ÂèØ„Åô„Çã
  const onFetchComplete = (tableIndex: number) => {
    // Êó¢„Å´ÁèæÂú®„ÅÆ„ÉÜ„Éº„Éñ„É´„ÅÆindex„Çà„ÇäcurrentActiveIndex„ÅåÂ§ß„Åç„Åë„Çå„Å∞„É™„Çø„Éº„É≥
    if (tableIndex < currentActiveIndex || allFetched) return;
    console.log(
      "onFetchCompleteÈñ¢Êï∞ÂÆüË°å tableIndex",
      tableIndex,
      "currentActiveIndex",
      currentActiveIndex,
      tableIndex < currentActiveIndex
    );
    setCurrentActiveIndex((prevIndex) => prevIndex + 1); // activeIndex„Çí+1„Åó„Å¶Ê¨°„ÅÆ„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà„ÅÆ„Éï„Çß„ÉÉ„ÉÅ„ÇíË®±ÂèØ
  };
  // --------------------------- üå†Â≠ê„Ç≥„É≥„Éù„Éº„Éç„É≥„Éà„ÇíÈ†ÜÁï™„Å´„Éï„Çß„ÉÉ„ÉÅ„Åï„Åõ„Çãüå† ---------------------------

  if (!isMounted)
    return (
      <div className={`flex-center w-full`} style={{ minHeight: `calc(732px - 87px)`, paddingBottom: `87px` }}>
        <SpinnerBrand withBorder withShadow />
      </div>
    );

  return (
    <>
      {/* <section className={`${styles.company_table_screen} h-screen w-full bg-neutral-900 text-neutral-50`}> */}
      <section
        className={`${styles.screen_deal_boards} transition-bg05 w-full ${
          activeThemeColor === "theme-brand-f" ? `` : ``
        } ${activeThemeColor === "theme-brand-f-gradient" ? `${styles.theme_f_gradient}` : ``} 
                 ${activeThemeColor === "theme-black-gradient" ? `${styles.theme_black}` : ``} 
                ${activeThemeColor === "theme-simple17" ? `${styles.theme_simple17}` : ``} ${
          activeThemeColor === "theme-simple12" ? `${styles.theme_simple12}` : ``
        } ${stickyRow !== null ? `${styles.is_sticky}` : ``}`}
      >
        {/* ------------------- Row „ÉÅ„É£„Éº„Éà„Ç®„É™„Ç¢ ------------------- */}
        {!allFetched && (
          <div className={`flex-center fade08_forward mb-[20px] max-h-[369px] min-h-[369px] w-full`}>
            <SpinnerX />
          </div>
        )}
        {allFetched && (
          <div
            className={`${styles.grid_row} ${styles.col2} fade15_forward mb-[20px] min-h-[369px] w-full ${
              stickyRow === "row_trend" ? `${styles.sticky_row}` : ``
            }`}
          >
            <div className={`${styles.grid_content_card}`}>
              <div className={`${styles.card_wrapper} fade08_forward`}>
                <div className={`${styles.card_title_area}`}>
                  <div className={`${styles.card_title}`}>
                    <span>Â£≤‰∏äÊé®Áßª</span>
                  </div>
                </div>
                <div className={`${styles.main_container} flex-center`}>
                  <div
                    className={`flex h-full w-full items-center justify-center text-[13px] text-[var(--color-text-sub)]`}
                  >
                    <span>Â£≤‰∏äÁõÆÊ®ô„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ</span>
                  </div>
                </div>
              </div>
            </div>

            {displayEntityGroup !== null && !!queryDataMemberGroupByParentEntity?.length && (
              <div className={`${styles.grid_content_card}`}>
                <div className={`${styles.card_wrapper} fade08_forward`}>
                  <div className={`${styles.card_title_area}`}>
                    <div className={`${styles.card_title}`}>
                      <span>Â£≤‰∏äÁõÆÊ®ô„Ç∑„Çß„Ç¢</span>
                    </div>

                    <div
                      className={`${styles.btn} ${styles.basic} space-x-[4px]`}
                      onMouseEnter={(e) => {
                        // Â£≤‰∏äÁõÆÊ®ô„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÁä∂ÊÖã„Åß„ÅØ„Ç®„É≥„ÉÜ„Ç£„ÉÜ„Ç£id„ÅåÂ≠òÂú®„Åõ„Åö„ÄÅsticky„ÅåÊ©üËÉΩ„Åó„Å™„Åè„Å™„Çã„ÅÆ„Åß„ÄÅmain_entity_target„ÅÆÊñáÂ≠óÂàó„Çí„Çª„ÉÉ„Éà
                        const entityId = "main_entity_target";
                        handleOpenTooltip({
                          e: e,
                          display: "top",
                          content: stickyRow === entityId ? `Âõ∫ÂÆö„ÇíËß£Èô§` : `ÁîªÈù¢ÂÜÖ„Å´Âõ∫ÂÆö`,
                          marginTop: 9,
                        });
                      }}
                      onMouseLeave={handleCloseTooltip}
                      onClick={() => {
                        const entityId = "row_trend";
                        if (!entityId) return;
                        if (entityId === stickyRow) {
                          setStickyRow(null);
                        } else {
                          setStickyRow(entityId);
                        }
                        handleCloseTooltip();
                      }}
                    >
                      {stickyRow === "row_trend" && <TbSnowflakeOff />}
                      {stickyRow !== "row_trend" && <TbSnowflake />}
                      {stickyRow === "row_trend" && <span>Ëß£Èô§</span>}
                      {stickyRow !== "row_trend" && <span>Âõ∫ÂÆö</span>}
                    </div>
                  </div>
                  <div className={`${styles.main_container} flex-center`}>
                    <div
                      className={`flex h-full w-full items-center justify-center text-[13px] text-[var(--color-text-sub)]`}
                    >
                      <span>Â£≤‰∏äÁõÆÊ®ô„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ</span>
                    </div>
                  </div>
                </div>
              </div>
            )}
            {displayEntityGroup === null && (
              <div className={`${styles.grid_content_card}`}>
                <div className={`${styles.card_wrapper} fade08_forward`}>
                  <div className={`${styles.card_title_area}`}>
                    <div className={`${styles.card_title}`}>
                      <span>Â£≤‰∏äÁõÆÊ®ô„Ç∑„Çß„Ç¢</span>
                    </div>

                    <div className={`${styles.btn} ${styles.basic} space-x-[4px]`}>
                      <span>Âõ∫ÂÆö</span>
                    </div>
                  </div>
                  <div className={`${styles.main_container} flex-center`}>
                    <div
                      className={`flex h-full w-full items-center justify-center text-[13px] text-[var(--color-text-sub)]`}
                    >
                      <span>Â£≤‰∏äÁõÆÊ®ô„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì„ÄÇ</span>
                    </div>
                  </div>
                </div>
              </div>
            )}
          </div>
        )}
        {/* ------------------- Row „ÉÅ„É£„Éº„Éà„Ç®„É™„Ç¢ ------------------- */}

        {/* ------------------- „Éç„ÇøË°®„Éú„Éº„Éâ ------------------- */}
        {displayMemberList &&
          displayMemberList.map((memberObj, tableIndex) => {
            return (
              <Fragment key={`${memberObj.id}_${tableIndex}_board`}>
                <div
                  // className={`${styles.entity_board_container} bg-[red]/[0]`}
                  className={`${styles.entity_board_container} fade15_forward bg-[red]/[0] ${
                    stickyRow === `deal_board_${memberObj.id}` ? `${styles.sticky_row}` : ``
                  }`}
                  // className={`${styles.entity_board_container} bg-[red]/[0] ${isRenderProgress ? `${styles.fade_bg}` : ``}
                  //  ${activeThemeColor === "theme-brand-f" ? `` : ``}
                  //  ${activeThemeColor === "theme-brand-f-gradient" ? `${styles.theme_f_gradient}` : ``}
                  //  ${activeThemeColor === "theme-black-gradient" ? `${styles.theme_black}` : ``}
                  // ${activeThemeColor === "theme-simple17" ? `${styles.theme_simple17}` : ``} ${
                  //   activeThemeColor === "theme-simple12" ? `${styles.theme_simple12}` : ``
                  // } ${stickyRow === `deal_board_${index}` ? `${styles.sticky_row}` : ``}`}
                >
                  {activeThemeColor === "theme-black-gradient" && <div className={`${styles.bg_black}`}></div>}
                  <div className={`${styles.entity_detail_container} fade08_forward bg-[green]/[0]`}>
                    <div className={`${styles.entity_detail_wrapper}`}>
                      <div className={`${styles.entity_detail} space-x-[12px] text-[12px]`}>
                        <AvatarIcon
                          // size={33}
                          size={36}
                          name={memberObj.profile_name ?? "Êú™Ë®≠ÂÆö"}
                          withCircle={false}
                          hoverEffect={false}
                          textSize={16}
                          // imgUrl={memberObj.avatar_url ?? null}
                        />
                        <div className={`${styles.entity_name} text-[19px] font-bold`}>
                          <span>{memberObj.profile_name}</span>
                        </div>
                        <div className={`${styles.sub_info} pt-[6px]`}>{memberObj.position_name ?? "ÂΩπËÅ∑Êú™Ë®≠ÂÆö"}</div>
                        <div className={`${styles.sub_info} pt-[6px]`}>{memberObj.assigned_employee_id_name ?? ""}</div>
                        <div
                          className={`relative !ml-[24px] !mr-[12px] flex h-full min-h-[56px] w-auto items-end bg-[red]/[0]`}
                        >
                          <div className="flex h-full min-w-[150px] items-end justify-end">
                            {/* <span className="mb-[-3px] text-[27px]">12,000,000,000</span> */}
                            <ProgressNumber
                              targetNumber={6200000}
                              // targetNumber={0}
                              // startNumber={Math.round(68000 / 2)}
                              // startNumber={Number((68000 * 0.1).toFixed(0))}
                              startNumber={0}
                              duration={3000}
                              easeFn="Quintic"
                              fontSize={27}
                              fontWeight={500}
                              margin="0 0 -3px 0"
                              isReady={isRenderProgress}
                              fade={`fade08_forward`}
                            />
                          </div>
                          <div className="relative h-full min-w-[33px]">
                            <div className="absolute left-[66%] top-[68%] min-h-[2px] w-[30px] translate-x-[-50%] translate-y-[-50%] rotate-[120deg] bg-[var(--color-text-title)]"></div>
                          </div>
                          <div className="mr-[12px] flex h-full min-w-max items-end justify-start">
                            <span className="text-[16px]">9,000,000</span>
                            {/* <span className="text-[16px]">12,000,000,000</span> */}
                          </div>
                        </div>
                        {/* <div className={`relative h-[56px] w-[66px]`} style={{ margin: `0` }}> */}
                        <div className={`relative h-[56px] w-[56px]`} style={{ margin: `0` }}>
                          <div className="absolute bottom-[-6px] right-0">
                            <ProgressCircle
                              circleId={`${memberObj.id}_${tableIndex}_board`}
                              textId={`${memberObj.id}_${tableIndex}_board`}
                              progress={78}
                              // progress={100}
                              // progress={0}
                              duration={5000}
                              easeFn="Quartic"
                              size={56}
                              strokeWidth={6}
                              fontSize={11}
                              textColor="var(--color-text-title)"
                              isReady={isRenderProgress}
                              fade={`fade08_forward`}
                              // fade={`fade10_forward`}
                            />
                          </div>
                        </div>
                      </div>
                    </div>
                    <div className={`${styles.status_col_wrapper}`}>
                      <div className={`flex h-full items-start pt-[10px]`}>
                        <div
                          className={`${styles.btn} ${styles.basic} space-x-[4px]`}
                          onMouseEnter={(e) => {
                            // Â£≤‰∏äÁõÆÊ®ô„ÅåË®≠ÂÆö„Åï„Çå„Å¶„ÅÑ„Å™„ÅÑÁä∂ÊÖã„Åß„ÅØ„Ç®„É≥„ÉÜ„Ç£„ÉÜ„Ç£id„ÅåÂ≠òÂú®„Åõ„Åö„ÄÅsticky„ÅåÊ©üËÉΩ„Åó„Å™„Åè„Å™„Çã„ÅÆ„Åß„ÄÅmain_entity_target„ÅÆÊñáÂ≠óÂàó„Çí„Çª„ÉÉ„Éà
                            const entityId = "main_entity_target";
                            handleOpenTooltip({
                              e: e,
                              display: "top",
                              content: stickyRow === entityId ? `Âõ∫ÂÆö„ÇíËß£Èô§` : `ÁîªÈù¢ÂÜÖ„Å´Âõ∫ÂÆö`,
                              marginTop: 9,
                            });
                          }}
                          onMouseLeave={handleCloseTooltip}
                          onClick={() => {
                            const entityId = `deal_board_${memberObj.id}`;
                            if (!entityId) return;
                            if (entityId === stickyRow) {
                              setStickyRow(null);
                            } else {
                              setStickyRow(entityId);
                            }
                            handleCloseTooltip();
                          }}
                        >
                          {stickyRow === `deal_board_${memberObj.id}` && <TbSnowflakeOff />}
                          {stickyRow !== `deal_board_${memberObj.id}` && <TbSnowflake />}
                          {stickyRow === `deal_board_${memberObj.id}` && <span>Ëß£Èô§</span>}
                          {stickyRow !== `deal_board_${memberObj.id}` && <span>Âõ∫ÂÆö</span>}
                        </div>
                      </div>
                      {/* <div className={`${styles.status_flex_wrapper}`}>
                      <div className={`${styles.right_spacer}`}></div>
                    </div> */}
                    </div>
                  </div>
                  <ErrorBoundary FallbackComponent={ErrorFallback}>
                    <Suspense fallback={<FallbackDealBoard />}>
                      <DealBoard
                        companyId={userProfileState.company_id!}
                        userId={memberObj.id}
                        // periodType={activePeriodSDB.periodType}
                        // period={activePeriodSDB.period}
                        onFetchComplete={() => onFetchComplete(tableIndex)} // „Éç„ÇøË°®„Éú„Éº„Éâ„ÅÆindex„ÇíÊ∏°„Åô
                        fetchEnabled={tableIndex === currentActiveIndex || allFetched} // „Ç§„É≥„Éá„ÉÉ„ÇØ„Çπ„Åå‰∏ÄËá¥„Åó„Å¶„ÅÑ„Çã„Åã„ÄÅÂÖ®„Å¶„Éï„Çß„ÉÉ„ÉÅ„ÅåÂÆå‰∫Ü„Åó„Å¶„ÅÑ„ÇãÊôÇ„ÅÆ„Åø„Éï„Çß„ÉÉ„ÉÅ„ÇíË®±ÂèØ
                      />
                    </Suspense>
                  </ErrorBoundary>
                  {/* <FallbackDealBoard /> */}
                </div>
                {/* {isRenderProgress && (
                <div className="flex-center fade08_forward my-[12px] w-full px-[24px]">
                  <hr className="min-h-[1px] w-full bg-[var(--color-border-base)]" />
                </div>
              )} */}
              </Fragment>
            );
          })}

        {/* ------------------- „Éç„ÇøË°®„Éú„Éº„Éâ„Åì„Åì„Åæ„Åß ------------------- */}

        {/* ------------------- „ÉÜ„Çπ„Éà ------------------- */}
        {/* {Array(3)
          .fill(null)
          .map((_, index) => (
            <div key={`${index}_board`} className={`${styles.entity_board_container} bg-[red]/[0]`}>
              <div className={`${styles.entity_detail_container} bg-[green]/[0]`}>
                <div className={`${styles.entity_detail_wrapper}`}>
                  <div className={`${styles.entity_detail} space-x-[12px] text-[12px]`}>
                    <AvatarIcon size={33} name="‰ºäËó§Ë¨ôÂ§™" withCircle={false} hoverEffect={false} />
                    <div className={`${styles.entity_name} text-[19px] font-bold`}>
                      <span>‰ºäËó§ Ë¨ôÂ§™</span>
                    </div>
                    <div className={`${styles.sub_info} pt-[6px]`}>‰ª£Ë°®ÂèñÁ∑†ÂΩπ</div>
                    <div className={`${styles.sub_info} pt-[6px]`}>216088</div>
                  </div>
                </div>
              </div>
              <DealBoard />
            </div>
          ))} */}
        {/* ------------------- „ÉÜ„Çπ„Éà„Åì„Åì„Åæ„Åß ------------------- */}
      </section>
      {/* ------------------- „Éç„ÇøË°® Ë©≥Á¥∞„ÉªÁ∑®ÈõÜ„É¢„Éº„ÉÄ„É´ ------------------- */}
      {isOpenDealCardModal && selectedDealCard && <EditModalDealCard />}
      {/* ------------------- „Éç„ÇøË°® Ë©≥Á¥∞„ÉªÁ∑®ÈõÜ„É¢„Éº„ÉÄ„É´ „Åì„Åì„Åæ„Åß ------------------- */}
      {/* ------------------- ÂèóÊ≥®Ê∏à„Åø„Å´Â§âÊõ¥Âæå„ÅÆÂ£≤‰∏äÂÖ•Âäõ„É¢„Éº„ÉÄ„É´ ------------------- */}
      {isOpenCongratulationsModal && (
        <ErrorBoundary FallbackComponent={ErrorFallback}>
          <Suspense fallback={<FallbackDealBoard />}>
            <GradientModal
              title1="ÂèóÊ≥®„Åä„ÇÅ„Åß„Å®„ÅÜüéâ"
              title2="„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ„Å´Â£≤‰∏ä„ÇíÂèçÊò†„Åï„Åõ„Åæ„Åó„Çá„ÅÜÔºÅ"
              tagText="ÂèóÊ≥®"
              contentText="ÂèóÊ≥®Ê∏à„Åø„ÅÆÊ°à‰ª∂„Å´„ÄåÂ£≤‰∏äÂïÜÂìÅ„ÉªÂ£≤‰∏ä‰æ°Ê†º„ÉªÂ£≤‰∏äÊó•‰ªò„Äç„ÇíË®òÈå≤„Åô„Çã„Åì„Å®„Åß„ÉÄ„ÉÉ„Ç∑„É•„Éú„Éº„Éâ‰∏ä„Å´Â£≤‰∏äÂÆüÁ∏æ„Å®ÈÅîÊàêÁéá„ÅåÂèçÊò†„Åï„Çå„Åæ„Åô„ÄÇ"
              btnActiveText="ÂèçÊò†„Åô„Çã"
              btnCancelText="Èñâ„Åò„Çã"
              illustText="ÂèóÊ≥®„Åä„ÇÅ„Åß„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„ÅôÔºÅ"
              handleClickActive={handleClickActiveSoldModal}
              handleClickCancel={handleClickCancelSoldModal}
            />
          </Suspense>
        </ErrorBoundary>
      )}
      {/* ------------------- ÂèóÊ≥®Ê∏à„Åø„Å´Â§âÊõ¥Âæå„ÅÆÂ£≤‰∏äÂÖ•Âäõ„É¢„Éº„ÉÄ„É´ „Åì„Åì„Åæ„Åß ------------------- */}
    </>
  );
};

export const ScreenDealBoards = memo(ScreenDealBoardsMemo);
