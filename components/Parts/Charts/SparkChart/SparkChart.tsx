import { convertToJapaneseCurrencyFormatInYen } from "@/utils/Helpers/Currency/convertToJapaneseCurrencyFormatInYen";
import { formatSalesTarget } from "@/utils/Helpers/formatSalesTarget";
import { subDays } from "date-fns";
import { memo, useEffect, useMemo, useState } from "react";
import { ResponsiveContainer, AreaChart, XAxis, YAxis, Area, Tooltip, CartesianGrid } from "recharts";

// const _data = useMemo(() => {
//   const data: { [K in "date" | "value"]: any }[] = [];
//   // for (let num = 30; num >= 0; num--) {
//   //   data.push({
//   //     date: subDays(new Date(), num).toISOString().substring(0, 10),
//   //     value: 1 + Math.random(),
//   //   });
//   // }
//   for (let num = 4; num >= 0; num--) {
//     data.push({
//       date: subDays(new Date(), num).toISOString().substring(0, 10),
//       value: 1 + Math.random(),
//     });
//   }
//   return data;
// }, []);

type Props = {
  id: string | number;
  title?: string;
  subTitle?: string;
  mainValue: number | null;
  growthRate?: number | null;
  data: { date: string | number | null; value: number | null }[];
  dataUpdateAt: number;
  height: number;
  width: number;
  chartHeight?: number;
  chartWidth?: number;
  //   stroke?: string;
  borderColor?: string;
  delay?: number;
  requireFormat4Letter?: boolean;
};

// export const SparkChart = ({
const SparkChartMemo = ({
  id,
  title = "Â£≤‰∏ä",
  subTitle = "ÂâçÂπ¥ÊØî",
  mainValue,
  growthRate,
  data,
  dataUpdateAt,
  height = 68,
  width = 270,
  //   chartHeight = 33,
  chartHeight = 30,
  //   chartWidth = 120,
  chartWidth = 100,
  borderColor = "var(--color-border-base)",
  delay,
  requireFormat4Letter = true,
}: //   stroke = "var(--bright-green)",
Props) => {
  // const [chartData, setChartData] = useState(data);

  // useEffect(() => {
  //   // ÈÖçÂàóÂÜÖ„ÅÆ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆdate„Éó„É≠„Éë„ÉÜ„Ç£„Åãvalue„Éó„É≠„Éë„ÉÜ„Ç£„ÅåÂ§âÊõ¥„Åï„Çå„Åü„Åì„Å®„ÇídataUpdateAt„ÅÆ„Çø„Ç§„É†„Çπ„Çø„É≥„Éó„ÅßÊ§úÁü•
  //   // ÈÄöÂ∏∏„ÅØÈÖçÂàóÂÜÖ„ÅÆÂêÑ„Ç™„Éñ„Ç∏„Çß„ÇØ„Éà„ÅÆË¶ÅÁ¥†„ÇíÂÖ®„Å¶JSONÊñáÂ≠óÂàóÂåñ„Åó„Å¶Ê∑±„ÅÑÁõ£Ë¶ñ„ÇíË°å„ÅÜ„Åå„ÄÅ„Åì„Çå„Å†„Å®„Éó„É≠„Éë„ÉÜ„Ç£Êï∞„ÇÑË¶ÅÁ¥†Êï∞„ÅåÂ§ö„Åè„Å™„Å£„ÅüÂ†¥Âêà„Å´„Éë„Éï„Ç©„Éº„Éû„É≥„Çπ„Åå‰Ωé‰∏ã„Åô„ÇãÂèØËÉΩÊÄß„Åå„ÅÇ„Çã„ÅÆ„Åß„ÄÅ„Çø„Ç§„É†„Çπ„Çø„É≥„Éó„ÅßÂ§âÊõ¥ÊôÇ„Å´ÊâãÂãï„ÅßÊúÄÊñ∞„ÅÆ„Çø„Ç§„É†„Çπ„Çø„É≥„Éó„Å´Êõ¥Êñ∞„Åô„ÇãÂΩ¢„ÅßÈÅãÁî®„Åô„Çã
  //   console.log("üî•üî•üî•üî•üî•üî• „Çπ„Éë„Éº„ÇØ„ÉÅ„É£„Éº„ÉàÂ§âÊõ¥Ê§úÁü•", "data", data, "dataUpdateAt", dataUpdateAt);
  //   setChartData(data);
  // }, [dataUpdateAt]);

  // „É°„Ç§„É≥value„Éï„Ç©„Éº„Éû„ÉÉ„Éà
  const displayMainValue = useMemo(() => {
    if (mainValue === null) return null;
    if (requireFormat4Letter) {
      const _value = formatSalesTarget(mainValue, "round");
      // const _value = convertToJapaneseCurrencyFormatInYen(mainValue, false, true);
      console.log("„Çπ„Éë„Éº„ÇØ„ÉÅ„É£„Éº„Éà displayMainValue useMemo", "_value", _value, "mainValue", mainValue, "data", data);
      return _value;
    } else {
      return mainValue;
    }
  }, [mainValue]);

  // Ââç„ÄÖÂπ¥„Åã„ÇâÂâçÂπ¥„Åå‰∏äÊòáÂÇæÂêë„Åã„Å©„ÅÜ„ÅãÂèñÂæó
  const isUpwardTrend = useMemo(() => {
    console.log("„Çπ„Éë„Éº„ÇØ„ÉÅ„É£„Éº„Éà isUpwardTrend useMemo growthRate", growthRate, "data.length", data.length);
    if (growthRate !== undefined) {
      if (growthRate === null) {
        if (data.length >= 2) {
          const lastValue = data[data.length - 1].value;
          const lastLastValue = data[data.length - 2].value;
          if (lastLastValue === 0 && lastValue && lastValue > 0) {
            return true;
          } else if (lastLastValue === lastValue) {
            return null;
          } else if (lastLastValue === null || lastValue === null) {
            return null;
          } else if (lastLastValue < lastValue) {
            return true;
          } else if (lastLastValue > lastValue) {
            return false;
          } else {
            return null;
          }
        } else {
          return null;
        }
      } else if (growthRate > 0) {
        return true;
      } else if (growthRate < 0) {
        return false;
      } else {
        return null;
      }
    } else {
      // 2„Å§‰ª•‰∏ã„Å™„Çânull
      if (data.length < 2) return null;
      const lastValue = data[data.length - 1].value;
      const lastLastValue = data[data.length - 2].value;
      if (lastValue === null || lastLastValue === null) return null;
      if (lastValue > lastLastValue) {
        return true;
      } else if (lastValue < lastLastValue) {
        return false;
      } else {
        return null; // Âêå„ÅòÂ†¥Âêà
      }
    }
  }, [growthRate, data]);

  const trendColor = isUpwardTrend
    ? `var(--bright-green)`
    : isUpwardTrend === false
    ? `var(--bright-red)`
    : `var(--color-bg-brand-f)`;

  // „ÉÅ„É£„Éº„Éà „Éû„Ç¶„É≥„Éà„Çí0.6sÈÅÖ„Çâ„Åõ„Çã
  const [isMounted, setIsMounted] = useState(delay ? false : true);
  useEffect(() => {
    if (isMounted) return;
    setTimeout(() => {
      setIsMounted(true);
    }, delay);
  }, []);

  // console.log("„ÉÅ„É£„Éº„Éà ", "isUpwardTrend", isUpwardTrend, "growthRate", growthRate, "data", data);

  return (
    <>
      <div
        className={`flex min-h-[48px] w-full max-w-[270px] items-center justify-between rounded-[9px] px-[12px]`}
        style={{ minHeight: `${height}px`, maxWidth: `${width}px`, border: `1px solid ${borderColor}` }}
      >
        <div className="flex max-w-[72px] flex-col justify-center">
          {/* <div className="flex flex-col justify-center"> */}
          <span className={`truncate text-[12px] font-bold text-[var(--color-text-title)]`}>{title}</span>
          <span className={`truncate text-[8px] text-[var(--color-text-sub)]`}>{subTitle}</span>
        </div>
        <div className={`flex items-center`}>
          <div
            className={`relative flex h-full min-h-[40px] w-full min-w-[120px] items-center`}
            style={{ minWidth: `${chartWidth}px`, maxWidth: `${chartWidth}px` }}
          >
            {isMounted && !!data?.length && (
              <ResponsiveContainer width="100%" height={chartHeight}>
                <AreaChart data={data} margin={{ top: 0, bottom: 0, right: 0, left: 0 }}>
                  <defs>
                    <linearGradient id={`spark_chart_gradient_${id}`} x1="0" y1="0" x2="0" y2="1">
                      {/* <stop offset="0%" stopColor={trendColor} stopOpacity={0.5} />
                    <stop offset="78%" stopColor={trendColor} stopOpacity={0.05} /> */}
                      {/* <stop offset="5%" stopColor={trendColor} stopOpacity={0.4} />
                      <stop offset="95%" stopColor={trendColor} stopOpacity={0} /> */}
                      <stop offset="12%" stopColor={trendColor} stopOpacity={0.4} />
                      <stop offset="98%" stopColor={trendColor} stopOpacity={0} />
                    </linearGradient>
                  </defs>
                  <Area dataKey={`value`} stroke={trendColor} fill={`url(#spark_chart_gradient_${id})`} />
                  {/* <XAxis dataKey="date" /> */}
                  {/* <YAxis dataKey="value" /> */}
                </AreaChart>
              </ResponsiveContainer>
            )}
            {!data?.length && <div className={`text-[9px]`}>„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</div>}
          </div>
          <div className={`flex min-w-[48px]  flex-col items-end justify-center`}>
            {/* <span className={`text-[12px] font-bold text-[var(--color-text-title)]`}>123.26ÂÑÑ</span> */}
            <span className={`text-[12px] font-bold text-[var(--color-text-title)]`}>{displayMainValue}</span>
            {/* <pre>{JSON.stringify(data, null,2)}</pre> */}
            <div
              className={`flex-center max-w-max rounded-[4px] bg-[var(--bright-green)] px-[5px] py-[1px] text-[8px] text-[#fff]`}
              style={{
                background: trendColor,
                // ...(isUpwardTrend && { background: `var(--bright-green)` }),
                // ...(isUpwardTrend === false && { background: `var(--bright-red)` }),
                // ...(isUpwardTrend === null && { background: `var(--color-bg-brand-sub)` }),
              }}
            >
              {growthRate === undefined && isUpwardTrend !== null && <span>{isUpwardTrend ? `+` : `-`}1.72%</span>}
              {growthRate === undefined && isUpwardTrend === null && <span>- %</span>}
              {growthRate !== undefined && growthRate !== null && isUpwardTrend !== null && (
                <span>
                  {isUpwardTrend && !growthRate.toString().includes("+")
                    ? `+`
                    : !growthRate.toString().includes("-")
                    ? `-`
                    : ``}
                  {growthRate.toFixed(1)}%
                </span>
              )}
              {growthRate !== undefined && growthRate === null && <span>- %</span>}
              {growthRate === 0 && <span>{growthRate}%</span>}
            </div>
          </div>
        </div>
      </div>
    </>
  );
};

export const SparkChart = memo(SparkChartMemo);
